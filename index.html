<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Voice Command to ESP32</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 2em;
      background-color: #f4f4f4;
    }

    .container {
      background: #fff;
      padding: 2em;
      margin: auto;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 500px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 1em 0.5em;
      cursor: pointer;
    }

    #current-command {
      font-size: 2em;
      color: #007BFF;
      margin-top: 1em;
    }

    #status, #ble-status, #send-status {
      font-style: italic;
      margin-top: 0.5em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Voice-Controlled ESP32</h1>
    <button onclick="connectBLE()">Connect to ESP32</button>
    <button onclick="init()">Start Listening</button>

    <div id="ble-status">BLE: Not connected</div>
    <div id="status">Model not started.</div>
    <div id="current-command">Waiting for command...</div>
    <div id="send-status">Command send status: Not sent</div>
  </div>

  <!-- TensorFlow.js and Speech Commands model -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

  <script>
    const URL = "https://teachablemachine.withgoogle.com/models/G2FB34AGs/";
    let lastPrediction = "";
    let recognizer;

    let bleDevice = null;
    let bleCharacteristic = null;

    const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';

    async function connectBLE() {
      console.log("Connecting to ESP32...");
      const status = document.getElementById("ble-status");
      try {
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "ESP32" }],
          optionalServices: [SERVICE_UUID]
        });

        const server = await bleDevice.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

        status.innerText = "BLE: Connected to ESP32";
        console.log("BLE connected and characteristic ready.");
      } catch (error) {
        console.error("BLE Connection error:", error);
        status.innerText = "BLE: Connection failed";
      }
    }

    async function sendCommandToESP32(command) {
      const sendStatus = document.getElementById("send-status");

      if (!bleCharacteristic) {
        sendStatus.innerText = "Command send status: ESP32 not connected.";
        console.warn("ESP32 not connected yet.");
        return;
      }

      try {
        const encoder = new TextEncoder();
        await bleCharacteristic.writeValue(encoder.encode(command));
        console.log("Sent to ESP32:", command);
        sendStatus.innerText = `Command send status: "${command}" sent successfully.`;
      } catch (err) {
        console.error("Failed to send command:", err);
        sendStatus.innerText = "Command send status: Failed to send.";
      }
    }

    async function createModel() {
      const checkpointURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      recognizer = speechCommands.create("BROWSER_FFT", undefined, checkpointURL, metadataURL);
      await recognizer.ensureModelLoaded();
      return recognizer;
    }

    async function init() {
      const modelStatus = document.getElementById("status");
      const commandStatus = document.getElementById("current-command");

      modelStatus.innerText = "Loading model...";
      const recognizer = await createModel();
      const classLabels = recognizer.wordLabels();
      modelStatus.innerText = "Listening...";

      recognizer.listen(async result => {
        const scores = result.scores;
        let maxScore = -Infinity;
        let predictedClass = "";

        for (let i = 0; i < scores.length; i++) {
          if (scores[i] > maxScore) {
            maxScore = scores[i];
            predictedClass = classLabels[i];
          }
        }

        if (predictedClass !== lastPrediction && maxScore > 0.75) {
          lastPrediction = predictedClass;
          commandStatus.innerText = predictedClass;
          await sendCommandToESP32(predictedClass);
        }

      }, {
        includeSpectrogram: false,
        probabilityThreshold: 0.75,
        overlapFactor: 0.5,
        invokeCallbackOnNoiseAndUnknown: false
      });
    }
  </script>
</body>
</html>
